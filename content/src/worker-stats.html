<!DOCTYPE html>
<html>
  <head>
    <title>ServiceWorker stats for ${worker_scope}</title>
    <style>
.hit { color: green }
.miss { color: red }
.error { color: red }
.updated { color: orange }
.fallback { color: red }
.skip { color: gray }
    </style>
    <script>

function loadData() {
  var r = new XMLHttpRequest();
  r.open("GET", "/stats/get");
  r.responseType = "json";
  r.onreadystatechange = function() {
    if (r.readyState == 4) {
      onDataReady(r.response);
    }
  };
  r.send();
}

function onDataReady(data) {
  ["worker_scope", "cache_hits", "cache_misses", "cache_errors"].forEach(function(key) {
    var el = document.getElementById(key);
    el.textContent = data[key];
  });
  ["main_cache_keys", "user_cache_keys", "recent_requests"].forEach(function(key) {
    constructListElement(document.getElementById(key), data[key]);
  });
}

function constructListElement(parentNode, list) {
  while (parentNode.hasChildNodes()) {
    parentNode.removeChild(parentNode.childNodes[0]);
  }
  if (!Array.isArray(list)) {
    return;
  }

  var list_element = document.createElement('UL');
  list.sort().forEach(function(value) {
    var el = document.createElement('LI');
    if (Array.isArray(value)) {
      var tag_text = {
        hit: "HIT",
        miss: "MISS",
        error: "ERROR",
        updated: "Updated",
        fallback: "Network failed",
        skip: "Skipped"
      };
      el.appendChild(document.createTextNode(value.shift()));
      value.forEach(function(tag) {
        var span = document.createElement('SPAN');
        span.appendChild(document.createTextNode(' ' + tag_text[tag]));
        span.classList.add(tag);
        el.appendChild(span);
      });
    } else {
      el.textContent = value;
    }
    list_element.appendChild(el);
  });
  parentNode.appendChild(list_element);
}

function killCache() {
  var r = new XMLHttpRequest();
  r.open("GET", "/stats/killcache");
  r.addEventListener("readystatechange", function() {
    if (r.readyState == 4) {
      loadData();
    }
  });
  r.send();
}
    </script>
  </head>
  <body onload="loadData()">
    <h1>ServiceWorker stats for <span id="worker_scope">PencilCode</span></h1>
    <p>Cache hits: <span id="cache_hits">Loading...</span></p>
    <p>Cache misses: <span id="cache_misses">Loading...</span></p>
    <p>Cache errors: <span id="cache_errors">Loading...</span></p>
    <p><input type="button" onclick="killCache()" value="Kill caches"></input></p>
    <h3>Recent activity</h3>
    <div id="recent_requests">
    </div>
    <h3>Main cache keys</h3>
    <div id="main_cache_keys">
    </div>
    <h3>User cache keys</h3>
    <div id="user_cache_keys">
    </div>
  </body>
</html>
